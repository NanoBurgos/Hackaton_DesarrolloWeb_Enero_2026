<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadHunter Pro - ProspecciÃ³n Digital</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='estilos.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">
        <header>
            <h1>LeadHunter Pro </h1>
            <div class="user-info">
                <a href="/exportar" class="badge export-btn" style="text-decoration:none">Exportar CSV </a>
                <a href="/limpiar" class="badge"
                    style="text-decoration:none; background: var(--danger); border-color: var(--danger);">Limpiar
                    Historial </a>
                <span style="margin-left:1rem">Freelancer Demo</span>
            </div>
        </header>

        <section class="controls">
            <form action="/scrapear" method="POST" style="display:flex; gap:1rem; width:100%">
                <input type="text" name="query" placeholder="Ej: Restaurante en AsunciÃ³n" style="flex-grow:1" required>
                <button type="submit">Scrapear Leads</button>
            </form>
        </section>

        <div id="map"></div>

        <section class="filters-bar">
            <label class="switch-container">
                <input type="checkbox" id="filterWeb">
                <span class="slider"></span>
                <span class="label-text">Mostrar solo oportunidades (Sin Web) </span>
            </label>
            <span id="resultsCount" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
        </section>

        <div class="grid" id="resultsGrid">
            {% for n in negocios %}
            <div class="card" data-lat="{{ n.lat }}" data-lon="{{ n.lon }}" data-nombre="{{ n.nombre }}">
                <h3>{{ n.nombre }}</h3>
                <p><strong>CategorÃ­a:</strong> {{ n.categoria }}</p>
                <p><strong></strong> {{ n.direccion }}</p>
                <p><strong></strong> {{ n.rating or 'N/A' }} | <strong>ðŸ“ž</strong> {{ n.telefono or 'N/A' }}</p>

                {% if not n.tiene_web %}
                <span class="badge badge-web-no">Oportunidad: Sin Web ðŸŸ¢</span>
                {% else %}
                <span class="badge badge-web-yes">Tiene Web ðŸ”´</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const map = L.map('map').setView([-25.2867, -57.647], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const markers = [];
            const cards = document.querySelectorAll('.card');

            cards.forEach(card => {
                const lat = card.dataset.lat;
                const lon = card.dataset.lon;
                const nombre = card.dataset.nombre;
                const hasWeb = card.querySelector('.badge-web-yes') !== null;

                if (lat && lon) {
                    const marker = L.marker([lat, lon]).addTo(map)
                        .bindPopup(`<b>${nombre}</b>`);
                    markers.push({ marker, hasWeb, card });
                }
            });

            const filterToggle = document.getElementById('filterWeb');
            const resultsCount = document.getElementById('resultsCount');

            function applyFilter() {
                const showOnlyNoWeb = filterToggle.checked;
                let visibleCount = 0;

                markers.forEach(({ marker, hasWeb, card }) => {
                    const shouldShow = !showOnlyNoWeb || !hasWeb;

                    if (shouldShow) {
                        marker.addTo(map);
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        map.removeLayer(marker);
                        card.style.display = 'none';
                    }
                });

                resultsCount.textContent = `Mostrando ${visibleCount} de ${cards.length} resultados`;
            }

            filterToggle.addEventListener('change', applyFilter);
            applyFilter(); // Ejecutar al cargar
        });
    </script>
</body>

</html>